@using Common;
@using Common.DTO;
@using Common.Helpers;
@using Newtonsoft.Json;
@using marketioBlazor.Authentication;
@using RestSharp;
@using marketioBlazor.Components.UI
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager navManager
@inject ApiClientService ApiClient
@inject IToastService toastService

<EditForm Model="_listing" OnValidSubmit="@HandleValidSubmit" class="bg-dark p-3 rounded text-white">
    <DataAnnotationsValidator />
    @*<ValidationSummary />*@

    <div class="form-group d-grid gap-2">
        @*title*@
        <label for="email">Title</label>
        <InputText class="form-control" id="email" @bind-Value="_listing.Title" placeholder="enter your title here" />
        <ValidationMessage For="@(() => _listing.Title)" />

        @*first name*@
        <label for="description">Description</label>
        <InputText class="form-control" id="firstName" @bind-Value="_listing.Description" placeholder="description" />
        <ValidationMessage For="@(() => _listing.Description)" />

        @* category *@
        <label for="category">Category</label>
        <InputSelect class="form-select" id="category"  @bind-Value="_listing.CategoryId">
            @foreach (var category in _listingCategories)
            {
                <option value="@category.Id">@category.Name</option>
            }
        </InputSelect>


        @* Price *@
        <label class="">Price</label>
        <div class="input-group m-0 p-0">
            <span class="input-group-text">$</span>
            <input disabled="@_listing.IsNegotiable" type="number" class="form-control" @bind-value="_listing.Price" aria-label="Amount (to the nearest dollar)">
            <span class="input-group-text">.00</span><br/>
        </div>
        <ValidationMessage For="@(() => _listing.Price)" />

        @* is negotiable*@
        <div class="d-flex gap-3">
            <span class="form-label">Price is Negotiable?</span>
            <InputCheckbox @onclick="(() => {
                        if (_listing.IsNegotiable)
                            _listing.Price = 0;
                        })" 
            @bind-Value="_listing.IsNegotiable" class="form-check-input" id="isNegotiable" />
        </div>

        @* tags *@
        <div>
            <label for="tags">Tags &nbsp;<span class="text-muted">(enter space separated values below)</span></label>
            <InputText class="form-control" id="tags"  maxLength="50"
            @bind-Value="_tagString" placeholder="enter your tags here" />
            <small id="emailHelp" class="form-text text-muted">Tags will help other users when searching for your listing.</small
            <div class="mt-3">
                Selected Tags:
                @foreach (var tag in _tagString.Split(' '))
                {
                    <span class=" me-2 badge rounded-pill bg-info">@tag</span>
                }
            </div>
        </div>

    </div>

    @*submit button*@
    <button type="submit" class="btn btn-light my-3">
        Create @*<Spinner />*@
    </button>

    @*error message display *@
    <label class="text-danger fw-bold">@errorMessage</label>

    <br />

    Already have an account?
    <NavLink class="text-secondary" href="login">
        Go to login page
    </NavLink>

</EditForm>

@code {
    string _tagString = "";
    private List<ListingTag> _tags;

    private EditContext? editContext;
    private string errorMessage = "";
    private Listing _listing = new Listing();

    private List<ListingCategory> _listingCategories = new List<ListingCategory>();

    protected override async Task OnInitializedAsync()
    {
        editContext = new(_listing);

        // get categories with api
        ApiClient = new ApiClientService();
        _listingCategories = await ApiClient.GetAllAsync<ListingCategory>("listingcategories");
    }

    private async void HandleValidSubmit()
    {
        try
        {
            if (editContext != null && editContext.Validate())
            {
                // get user from session
                var authState = (CustomAuthenticationStateProvider)authStateProvider;
                UserSessionDTO userSession = await authState.GetToken();

                if (userSession == null)
                {
                    errorMessage = "Invalid session.";
                    return;
                }

                // set category 
                _listing.Category = _listingCategories.FirstOrDefault(x => x.Id == _listing.CategoryId) ?? _listingCategories[0];

                // add user to listing
                //_listing.UserId = userSession.UserId;
                _listing.User = await ApiClient.GetByIdAsync<User>(userSession.UserId);

                // add tags to listing
                _listing.TagString = _tagString.Trim().Split(' ');

                //_tags.ForEach(tag => _listing.ListingTags.Add(new ListingTag() { Name = tag, ListingId = _listing.Id }));

                _listing.DateCreated = DateTime.UtcNow;

                // update data
                var response = await CreateListing(); // create the account

                if (response.IsSuccessStatusCode)
                    navManager.NavigateTo("/listings", true);
                else
                    errorMessage = "Failed to reach server.";

                return;
            }
        }
        catch { }

        errorMessage = "Something went wrong.";
    }

    public async Task<RestResponse> CreateListing()
    {
        ApiClient = new ApiClientService();
        return await ApiClient.CreateAsync<Listing>(_listing);
    }   

}